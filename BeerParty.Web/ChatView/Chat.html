<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft.signalr/6.0.0/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #messagesList {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .message {
            margin: 5px 0;
        }

        .sender {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Chat</h1>
    <input type="text" id="userInput" placeholder="Ваше имя" />
    <input type="text" id="receiverInput" placeholder="Получатель" />
    <input type="text" id="messageInput" placeholder="Сообщение" />
    <button id="sendButton">Отправить</button>

    <div id="messagesList"></div>

    <script>
        // Убедитесь, что SignalR подключен
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub") // Убедитесь, что маршрут соответствует маршруту хаба
            .build();

        // Обработчик получения сообщения
        connection.on("ReceiveMessage", (sender, message) => {
            const msg = document.createElement("div");
            msg.classList.add("message");
            msg.innerHTML = `<span class="sender">${sender}:</span> ${message}`;
            document.getElementById("messagesList").appendChild(msg);
            document.getElementById("messagesList").scrollTop = document.getElementById("messagesList").scrollHeight;
        });

        // Запуск подключения
        connection.start()
            .then(() => console.log("Подключение к SignalR установлено"))
            .catch(err => console.error("Ошибка подключения к SignalR:", err));

        document.getElementById("sendButton").addEventListener("click", async () => {
            const sender = document.getElementById("userInput").value;
            const receiver = document.getElementById("receiverInput").value;
            const message = document.getElementById("messageInput").value;

            if (sender && receiver && message) {
                const chatMessage = {
                    sender: sender,
                    receiver: receiver,
                    message: message
                };

                console.log("Отправка сообщения:", chatMessage); // Для отладки

                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(chatMessage)
                    });

                    if (response.ok) {
                        console.log("Сообщение успешно отправлено.");
                        document.getElementById("messageInput").value = ''; // Очистить поле ввода сообщения
                    } else {
                        console.error("Ошибка при отправке сообщения:", response.statusText);
                    }
                } catch (error) {
                    console.error("Ошибка сети:", error);
                }
            } else {
                alert("Пожалуйста, заполните все поля!");
            }
        });
    </script>
</body>
</html>
